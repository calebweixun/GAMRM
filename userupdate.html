<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GA使用者資料更新介面</title>
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="userupdate.css" />
  </head>
  <body>
    <div class="container">
      <!-- Email 搜尋表單 -->
      <div class="form-container">
        <label for="email"></label>
        <input type="text" id="email" placeholder="請輸入 Email 查詢個人資料" />
        <input type="button" value="搜尋" onclick="searchUserData()" />
      </div>

      <!-- 查詢加載提示 -->
      <div id="loading">正在取得資料，請稍候...</div>

      <!-- 顯示資料區域 -->
      <div class="data-container" id="dataContainer"></div>
    </div>

    <script>
      <!-- JavaScript 文件 -->
      var url =
        "https://script.google.com/macros/s/AKfycbxjXUF-tnhQHyvJJx4RPEBiymE6SlnZPx6EMDqVnrzUdYi62ROwa46betw0P66ICbT2vA/exec";

      function searchUserData() {
        var email = document.getElementById("email").value;

        if (!email) {
          alert("尚未輸入 Email！");
          return;
        }

        // 顯示查詢提示
        document.getElementById("dataContainer").style.display = "none";
        document.getElementById("loading").style.display = "block";
        document.body.style.cursor = "wait"; // 改變滑鼠為忙碌狀態

        // 透過 Google Apps Script 取得資料
        var params = new URLSearchParams({
          action: "getUserInfo",
          email: email,
        });

        fetch(url + "?" + params.toString(), {
          method: "GET", // 使用 GET 請求
          headers: {
            "Content-Type": "text/plain", // 設置請求內容為 text/plain
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
            displayData(data);
          })
          .catch((error) => console.error("Error:", error));
      }

      // 顯示搜尋結果並允許 修改
      function displayData(data) {
        var container = document.getElementById("dataContainer");
        container.innerHTML = ""; // 清空之前的內容
        document.getElementById("loading").style.display = "none"; // 隱藏 加載提示
        document.body.style.cursor = "default"; // 返還滑鼠為正常狀態

        if (data.Status === "Not Found") {
          container.style.display = "flex"; // 隱藏 加載提示
          container.innerHTML = "找不到相關資料，請洽GA招待組人員";
          return;
        }

        // 顯示資料並提供 修改框
        container.innerHTML = `
            <h3>請確認以下資料，並於修改後確認更新</h3>
            <label for="name">姓名:</label>
            <input type="text" id="name" value="${data.Name}">
            <br>
            <label for="nickname">暱稱/英文名:</label>
            <input type="text" id="nickname" value="${data.NickName}">
            <br>
            <label for="phone">手機號:</label>
            <input type="text" id="phone" value="${data.Phone}">
            <br>
            <label for="lineId">LINE ID:</label>
            <input type="text" id="lineId" value="${data.LINEID}">
            <br>
            <input type="button" value="確認更新" onclick="updateUserData()">
            `;

        // 顯示資料區塊
        container.style.display = "block";
      }

      // 更新資料到 Google Sheets
      function updateUserData() {
        var email = document.getElementById("email").value;
        var name = document.getElementById("name").value;
        var nickname = document.getElementById("nickname").value;
        var phone = document.getElementById("phone").value;
        var lineId = document.getElementById("lineId").value;

        if (!email || !name || !nickname || !phone || !lineId) {
          alert("請填寫所有欄位！");
          return;
        }

        // 顯示搜尋结果並允許編輯
        document.getElementById("loading").style.display = "none"; // 隱藏 加載提示
        document.body.style.cursor = "default"; // 返還滑鼠為正常狀態

        var params = new URLSearchParams({
          action: "updateUserInfo",
          email: email,
          name: name,
          nickname: nickname,
          phone: phone,
          lineId: lineId,
        });

        // 呼叫 Google Apps Script 來更新資料，並等待回應
        fetch(url + "?" + params.toString(), {
          method: "GET", // 使用 GET 請求
          headers: {
            "Content-Type": "text/plain", // 設置請求內容為 text/plain
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "OK") {
              alert("資料已更新！");
              return;
            } else {
              alert("更新失敗，請稍後再試！");
              return;
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // 函數 定義
    </script>
  </body>
</html>
